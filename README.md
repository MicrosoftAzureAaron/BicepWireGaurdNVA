# BicepWireGuardNVA

This repo stores a deployment that creates a VNET with an NVA and a WireGuard tunnel NVA.

The deployment provisions all resources for the first time, including:
- User Assigned Managed Identity for the VM
- VNET
- Key Vault and Private Endpoint with Linked Private DNS zone
- Wiregaurd NVA VM
- OS Disk
- NIC
- Public IP
## Key Vault Values

During the first deployment, the following values are entered and stored in the Key Vault. If you already have the Private and Public keys for the WireGuard NVA, you can enter them; otherwise, they will be generated automatically on the first run.

| Key                        | Description                                                                                                   |
|----------------------------|---------------------------------------------------------------------------------------------------------------|
| `remoterouter`             | Home router's public IP and WireGuard port, or FQDN:PORT                                                      |
| `remoteserverpublickey`    | Home router's public key                                                                                      |
| `remotenetwork`            | Home local LAN IP range (the network that the NVA is creating a tunnel to)                                    |
| `nvainterfaceip`           | The client IP (wg0 interface IP) that your router expects as the source. Must not overlap with Azure or remote networks. Configure this on your router. |
| `nvaprivatekey`  | *(Optional)* Private key for WireGuard NVA. Auto-generated by the first boot script if not provided.          |
| `nvapublickey`   | *(Optional)* Public key for WireGuard NVA. Auto-generated by the first boot script if not provided.           |

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoftAzureAaron%2FBicepWireGaurdNVA%2Fmain%2FGreenField.json)

---

Deploy the WireGuard NVA VM and new OS disk from scratch (assuming all other resources still exist):

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoftAzureAaron%2FBicepWireGaurdNVA%2Fmain%2FBrownField.json)